<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Y2mate-like Downloader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <h3 class="mb-3 text-center">YouTube Downloader</h3>
  <div class="input-group mb-3">
    <input id="urlInput" type="text" class="form-control" placeholder="Pega el enlace aquí...">
    <button id="startBtn" class="btn btn-danger">start ➜</button>
  </div>

  <div id="metaBarWrap" class="progress mb-3 d-none" style="height: 20px;">
    <div id="metaProgress" class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>

  <div id="metaBlock" class="d-none">
    <div class="row mb-3">
      <div class="col-md-3">
        <img id="thumb" class="img-fluid" alt="thumbnail">
      </div>
      <div class="col-md-9">
        <h5 id="title"></h5>
      </div>
    </div>

    <ul class="nav nav-tabs" id="formatTabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#audioTab" type="button" role="tab">Audio</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#videoTab" type="button" role="tab">Video</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#otherTab" type="button" role="tab">Other</button></li>
    </ul>
    <div class="tab-content p-3 border border-top-0">
      <div class="tab-pane fade show active" id="audioTab" role="tabpanel">
        <table class="table"><tbody id="audioBody"></tbody></table>
      </div>
      <div class="tab-pane fade" id="videoTab" role="tabpanel">
        <table class="table"><tbody id="videoBody"></tbody></table>
      </div>
      <div class="tab-pane fade" id="otherTab" role="tabpanel">
        <table class="table"><tbody id="otherBody"></tbody></table>
      </div>
    </div>
  </div>

  <div id="dlBarWrap" class="progress mt-3 d-none" style="height: 20px;">
    <div id="dlProgress" class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>
  <div id="dlActions" class="mt-2"></div>
</div>

<script>
async function fetchJson(url, opts) { const r = await fetch(url, opts); return r.json(); }
function row(label, selector, type, extra, ext, abr) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${label}</td><td>${extra||''}</td><td><button class="btn btn-success btn-sm">Download</button></td>`;
  tr.querySelector('button').addEventListener('click', () => startDownload(selector, type, { ext, abr }));
  return tr;
}

document.getElementById('startBtn').addEventListener('click', async () => {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return;
  document.getElementById('dlActions').innerHTML='';
  document.getElementById('dlBarWrap').classList.add('d-none');
  const dlBar = document.getElementById('dlProgress'); dlBar.style.width='0%'; dlBar.textContent='0%';
  const metaWrap = document.getElementById('metaBarWrap');
  metaWrap.classList.remove('d-none');
  const metaBar = document.getElementById('metaProgress');
  metaBar.style.width = '10%'; metaBar.textContent = '10%';
  const meta = await fetchJson('/api/metadata', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) });
  metaBar.style.width = '100%'; metaBar.textContent = '100%';
  metaWrap.classList.add('d-none');
  if (!meta.available) { alert(meta.message || 'URL no disponible'); return; }
  document.getElementById('metaBlock').classList.remove('d-none');
  document.getElementById('title').textContent = meta.title || '';
  if (meta.thumbnail) document.getElementById('thumb').src = meta.thumbnail;
  const vb = document.getElementById('videoBody'); vb.innerHTML='';
  const ob = document.getElementById('otherBody'); ob.innerHTML='';
  const ab = document.getElementById('audioBody'); ab.innerHTML='';
  (meta.videoFormats||[]).forEach(f => vb.appendChild(row(`${f.label}`, f.selector, 'video', f.ext?.toUpperCase(), f.ext)));
  if (!meta.videoFormats || meta.videoFormats.length === 0) { vb.innerHTML = '<tr><td colspan="3">No hay formatos de video disponibles</td></tr>'; }
  (meta.otherFormats||[]).forEach(f => ob.appendChild(row(`${f.label}`, f.selector, 'other', f.ext?.toUpperCase(), f.ext)));
  if (!meta.otherFormats || meta.otherFormats.length === 0) { ob.innerHTML = '<tr><td colspan="3">No hay formatos disponibles en Other</td></tr>'; }
  (meta.audioFormats||[]).forEach(f => ab.appendChild(row(`${f.label}`, f.selector, 'audio', f.ext.toUpperCase(), f.ext, f.abr)));
  if (!meta.audioFormats || meta.audioFormats.length === 0) { ab.innerHTML = '<tr><td colspan="3">No hay formatos de audio disponibles</td></tr>'; }
});

async function startDownload(selector, type, opts) {
  const url = document.getElementById('urlInput').value.trim();
  const body = { url, selector };
  if (type === 'audio') { body.audioFormat = 'mp3'; body.audioQuality = opts?.abr || 320; }
  if (type === 'video' || type === 'other') { body.ext = opts?.ext || 'mp4'; }
  const dlWrap = document.getElementById('dlBarWrap');
  dlWrap.classList.remove('d-none');
  const dlBar = document.getElementById('dlProgress');
  dlBar.style.width = '0%'; dlBar.textContent = '0%';
  const s = await fetchJson('/api/download/session', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  pollProgress(s.id);
}

async function pollProgress(id) {
  const bar = document.getElementById('dlProgress');
  const actions = document.getElementById('dlActions');
  actions.innerHTML = '';
  let done = false;
  while (!done) {
    const s = await fetchJson(`/api/download/${id}/progress`);
    const pct = Math.round((s.progress||0));
    bar.style.width = pct + '%'; bar.textContent = pct + '%';
    if (s.status === 'DONE') { done = true; actions.innerHTML = `<a class="btn btn-primary" href="/api/download/${id}/file">Download</a>`; document.getElementById('dlBarWrap').classList.add('d-none'); }
    else if (s.status === 'FAILED') { done = true; actions.textContent = 'Falló la descarga'; document.getElementById('dlBarWrap').classList.add('d-none'); }
    await new Promise(r => setTimeout(r, 1000));
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
